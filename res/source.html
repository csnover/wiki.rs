<!DOCTYPE html>
<html lang="en" class="syntect-code">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="content-security-policy" content="img-src 'self' data:; style-src 'self' 'unsafe-inline'; default-src 'self'; upgrade-insecure-requests">
        <title>wiki.rs</title>
        <link rel="stylesheet" href="<%= base_path %>/styles.css">
        <style>
            :root {
                --bottom-panel: 8rlh;
                padding: 1rem;
            }

            table {
                width: 100%;

                td {
                    vertical-align: top;

                    &:first-child,
                    &:nth-child(2) {
                        font-family: var(--sans);
                        font-variant-numeric: tabular-nums;
                        user-select: none;
                        white-space: nowrap;
                        width: 0;
                    }

                    + td {
                        padding-left: .5em;
                    }

                    &:last-child {
                        word-break: break-word;
                        word-wrap: break-word;
                    }
                }

                code {
                    white-space: pre-wrap;
                }

                form + & {
                    margin-bottom: var(--bottom-panel);
                }
            }

            button {
                all: unset;
                align-self: end;
                background-color: var(--border-fg);
                border: 1px outset;
                color: var(--fg);
                cursor: pointer;
                font-family: var(--sans);
                outline: initial;
                padding: 0 .5em;
                user-select: none;

                &:active {
                    background-color: lch(from var(--border-fg) calc(l - 20) c h);
                    border-style: inset;
                }
            }

            form {
                border-top: thick solid;
                bottom: 0;
                display: flex;
                height: var(--bottom-panel);
                left: 0;
                padding: .5em;
                position: fixed;
                right: 0;
            }

            .inputs,
            .boopables {
                display: flex;
                flex-direction: column;

                > :first-child {
                    flex: 1;
                }
            }

            .inputs {
                flex: 1;
            }

            .boopables {
                font-family: var(--sans);
                justify-content: end;

                > * + * {
                    /* actions */
                    margin-top: .5em;
                }

                > :first-child {
                    /* all the not-actions */

                    > * {
                        line-height: 1.2;
                        margin-left: 1.2em;
                        margin-top: .25em;
                        text-indent: -1.2em;

                        &:first-child {
                            margin-top: 0;
                        }

                        &:last-child {
                            margin-left: 2.4em;
                        }
                    }
                }
            }

            fieldset,
            textarea,
            input {
                background: inherit;
                border: none;
                color: inherit;
                font-family: var(--mono);
                font-size: 1em;
                resize: none;

                + textarea {
                    min-height: calc(var(--bottom-panel) * .25);
                }

                + textarea,
                + fieldset,
                + input {
                    border-top: thin solid var(--border-fg);
                    padding-top: .5em;
                }
            }

            label {
                cursor: pointer;
            }

            div:has(> label > [name=markers]),
            fieldset:not(:has(> legend > label > [name=include]:checked)) > textarea {
                cursor: default;
                opacity: .7;
                pointer-events: none;
                user-select: none;
            }

            div:has(> label > :is([value=tree], [value=pre]):checked) ~ div:has(> label > [name=markers])
            {
                cursor: unset;
                opacity: unset;
                pointer-events: unset;
                user-select: unset;
            }

            <%= crate::pages::filter::css(&css) %>
        </style>
    </head>
    <body>
        <% if let Some(form) = form { %>
            <form method="post" class="syntect-code">
                <div class="inputs">
                    <textarea name="code" autofocus autocorrect="off" autocomplete="off" placeholder="Wikitext goes here, to increase and/or reduce confusion"><%= form.code %></textarea>
                    <fieldset class="inputs">
                        <legend><label><input name="include" value="true" type="checkbox"<% if form.include == Some(true) { %> checked<% } %>> Transclude</label></legend>
                        <textarea name="args" autocorrect="off" autocomplete="off" placeholder="Optional template arguments, in the usual k=v|1=b|2|3 format"><%= form.args %></textarea>
                    </fieldset>
                    <input name="page_name" placeholder="Optional page name; defaults to (eval)" value="<%= form.page_name %>">
                </div>
                <div class="boopables">
                    <div>
                        <div><label><input name="mode" value="post" type="radio"<% if form.mode == crate::pages::EvalPp::Post { %> checked<% } %>> Show final</label></div>
                        <div><label><input name="mode" value="tree" type="radio"<% if form.mode == crate::pages::EvalPp::Tree { %> checked<% } %>> Show tree</label></div>
                        <div><label><input name="mode" value="pre" type="radio"<% if form.mode == crate::pages::EvalPp::Pre { %> checked<% } %>> Show PP (hehe)</label></div>
                        <div><label><input name="mode" value="pretree" type="radio"<% if form.mode == crate::pages::EvalPp::PreTree { %> checked<% } %>> Show PP tree</label></div>
                        <div><label><input name="markers" value="true" type="checkbox"<% if form.markers == Some(true) { %> checked<% } %>> Unstrip<br>markers</label></div>
                    </div>
                    <button><%- if time::UtcDateTime::now().second() & 1 == 1 { "Pray" } else { "Weep" } %></button>
                </div>
            </form>
        <% } %>
        <table class="syntect-code">
            <%
                let mut lines = lines;
                while let Some((offset, line, code)) = lines.next().transpose()? {
            %>
                <tr>
                    <td><small><%- offset %></small></td>
                    <td><%- line %></td>
                    <td><code><%- code %></code></td>
                </tr>
            <% } %>
        </table>
    </body>
</html>
