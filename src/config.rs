//! MediaWiki configuration.
//!
//! Wikitext documents are not self-encapsulated and cannot be parsed without
//! out-of-band configuration data. Most of this configuration data can be
//! acquired by querying the MediaWiki API for a given MediaWiki installation.

use super::title::{Namespace, NamespaceCase::FirstLetter};
use crate::wikitext::{Configuration, ConfigurationSource, MagicLinks};
use std::sync::LazyLock;

impl Namespace {
    /// The ID of the Scribunto `Module:` namespace.
    pub const MODULE: i32 = 828;

    /// Returns a list of all namespaces for this installation.
    pub fn all() -> &'static [Self] {
        NAMESPACES
    }

    /// Finds the namespace with the given numeric ID.
    pub fn find_by_id(id: i32) -> Option<&'static Self> {
        NAMESPACES.iter().find(|ns| ns.id == id)
    }

    /// Finds the namespace with the given case-insensitive name. Searches the
    /// name and all aliases.
    pub fn find_by_name(name: &str) -> Option<&'static Self> {
        NAMESPACES.iter().find(|ns| {
            ns.name.eq_ignore_ascii_case(name)
                || ns
                    .aliases
                    .iter()
                    .any(|alias| alias.eq_ignore_ascii_case(name))
        })
    }

    /// Returns the main namespace.
    pub fn main() -> &'static Self {
        Namespace::find_by_id(Namespace::MAIN).unwrap()
    }
}

/// The list of namespaces for this installation.
///
// TODO: This list should be generated by a tool like
// `fetch_mediawiki_configuration` and it should be part of the `CONFIG_SOURCE`.
static NAMESPACES: &[Namespace] = &[
    Namespace {
        id: -2,
        case: FirstLetter,
        canonical: None,
        name: "Media",
        default_content_model: None,
        subpages: false,
        content: false,
        aliases: &[],
    },
    Namespace {
        id: -1,
        case: FirstLetter,
        canonical: Some("Special"),
        default_content_model: None,
        name: "Special",
        subpages: false,
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 0,
        case: FirstLetter,
        canonical: None,
        subpages: true,
        content: true,
        default_content_model: None,
        name: "",
        aliases: &[],
    },
    Namespace {
        id: 1,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Talk"),
        default_content_model: None,
        name: "Talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 2,
        case: FirstLetter,
        subpages: true,
        canonical: Some("User"),
        default_content_model: None,
        name: "User",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 3,
        case: FirstLetter,
        subpages: true,
        canonical: Some("User talk"),
        default_content_model: None,
        name: "User talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 4,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Project"),
        default_content_model: None,
        name: "Wikipedia",
        content: false,
        aliases: &["WP"],
    },
    Namespace {
        id: 5,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Project talk"),
        default_content_model: None,
        name: "Wikipedia talk",
        content: false,
        aliases: &["WT"],
    },
    Namespace {
        id: 6,
        case: FirstLetter,
        canonical: Some("File"),
        default_content_model: None,
        name: "File",
        subpages: false,
        content: false,
        aliases: &["Image"],
    },
    Namespace {
        id: 7,
        case: FirstLetter,
        subpages: true,
        canonical: Some("File talk"),
        default_content_model: None,
        name: "File talk",
        content: false,
        aliases: &["Image talk"],
    },
    Namespace {
        id: 8,
        case: FirstLetter,
        canonical: Some("MediaWiki"),
        default_content_model: None,
        name: "MediaWiki",
        subpages: false,
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 9,
        case: FirstLetter,
        subpages: true,
        canonical: Some("MediaWiki talk"),
        default_content_model: None,
        name: "MediaWiki talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 10,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Template"),
        default_content_model: None,
        name: "Template",
        content: false,
        aliases: &["TM"],
    },
    Namespace {
        id: 11,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Template talk"),
        default_content_model: None,
        name: "Template talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 12,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Help"),
        default_content_model: None,
        name: "Help",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 13,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Help talk"),
        default_content_model: None,
        name: "Help talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 14,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Category"),
        default_content_model: None,
        name: "Category",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 15,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Category talk"),
        default_content_model: None,
        name: "Category talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 100,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Portal"),
        content: true,
        default_content_model: None,
        name: "Portal",
        aliases: &[],
    },
    Namespace {
        id: 101,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Portal talk"),
        default_content_model: None,
        name: "Portal talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 118,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Draft"),
        content: false,
        default_content_model: None,
        name: "Draft",
        aliases: &[],
    },
    Namespace {
        id: 119,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Draft talk"),
        default_content_model: None,
        name: "Draft talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 126,
        case: FirstLetter,
        subpages: false,
        canonical: Some("MOS"),
        content: false,
        default_content_model: None,
        name: "MOS",
        aliases: &[],
    },
    Namespace {
        id: 127,
        case: FirstLetter,
        subpages: false,
        canonical: Some("MOS talk"),
        default_content_model: None,
        name: "MOS talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 710,
        case: FirstLetter,
        canonical: Some("TimedText"),
        default_content_model: None,
        name: "TimedText",
        subpages: false,
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 711,
        case: FirstLetter,
        canonical: Some("TimedText talk"),
        default_content_model: None,
        name: "TimedText talk",
        subpages: false,
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 828,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Module"),
        // The API does not actually specify this but all the pages in this
        // namespace should call themselves Scribunto for scripts to work
        // properly, so just say it is so here
        default_content_model: Some("Scribunto"),
        name: "Module",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 829,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Module talk"),
        default_content_model: None,
        name: "Module talk",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 1728,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Event"),
        default_content_model: None,
        name: "Event",
        content: false,
        aliases: &[],
    },
    Namespace {
        id: 1729,
        case: FirstLetter,
        subpages: true,
        canonical: Some("Event talk"),
        default_content_model: None,
        name: "Event talk",
        content: false,
        aliases: &[],
    },
];

/// The static source configuration for this MW installation.
///
// TODO: This was created by a combination of `fetch_mediawiki_configuration`
// and hand-editing, which is obviously not sustainable.
static CONFIG_SOURCE: ConfigurationSource = ConfigurationSource {
    annotation_tags: phf::phf_set! {},
    annotations_enabled: false,
    behavior_switch_words: phf::phf_set! {
        "archivedtalk",
        "disambig",
        "expected_unconnected_page",
        "expectunusedcategory",
        "expectunusedtemplate",
        "expectwithoutscans",
        "forcetoc",
        "hiddencat",
        "index",
        "machinetranslation",
        "newsectionlink",
        "nocc",
        "nocontentconvert",
        "noeditsection",
        "nogallery",
        "noglobal",
        "noindex",
        "nonewsectionlink",
        "notalk",
        "notc",
        "notitleconvert",
        "notoc",
        "staticredirect",
        "toc",
    },
    extension_tags: phf::phf_set! {
        "categorytree",
        "ce",
        "charinsert",
        "chem",
        "gallery",
        "graph",
        "hiero",
        "imagemap",
        "indicator",
        "inputbox",
        "langconvert",
        "mapframe",
        "maplink",
        "math",
        "nowiki",
        "page-collection",
        "phonos",
        "poem",
        "pre",
        "ref",
        "references",
        "score",
        "section",
        "source",
        "syntaxhighlight",
        "templatedata",
        "templatestyles",
        "timeline",
    },
    function_hooks: phf::phf_set! {
        "ns",
        "nse",
        "urlencode",
        "lcfirst",
        "ucfirst",
        "lc",
        "uc",
        "localurl",
        "localurle",
        "fullurl",
        "fullurle",
        "canonicalurl",
        "canonicalurle",
        "formatnum",
        "grammar",
        "gender",
        "plural",
        "formal",
        "bidi",
        "numberingroup",
        "language",
        "padleft",
        "padright",
        "anchorencode",
        "defaultsort",
        "filepath",
        "pagesincategory",
        "pagesize",
        "protectionlevel",
        "protectionexpiry",
        "pagename",
        "pagenamee",
        "fullpagename",
        "fullpagenamee",
        "subpagename",
        "subpagenamee",
        "rootpagename",
        "rootpagenamee",
        "basepagename",
        "basepagenamee",
        "talkpagename",
        "talkpagenamee",
        "subjectpagename",
        "subjectpagenamee",
        "pageid",
        "revisionid",
        "revisionday",
        "revisionday2",
        "revisionmonth",
        "revisionmonth1",
        "revisionyear",
        "revisiontimestamp",
        "revisionuser",
        "cascadingsources",
        "namespace",
        "namespacee",
        "namespacenumber",
        "talkspace",
        "talkspacee",
        "subjectspace",
        "subjectspacee",
        "numberofarticles",
        "numberoffiles",
        "numberofusers",
        "numberofactiveusers",
        "numberofpages",
        "numberofadmins",
        "numberofedits",
        "bcp47",
        "dir",
        "interwikilink",
        "interlanguagelink",
        "int",
        "special",
        "speciale",
        "tag",
        "formatdate",
        "displaytitle",
        "if",
        "ifeq",
        "switch",
        "ifexist",
        "ifexpr",
        "iferror",
        "time",
        "timel",
        "timef",
        "timefl",
        "expr",
        "rel2abs",
        "titleparts",
        "pendingchangelevel",
        "categorytree",
        "lst",
        "lstx",
        "lsth",
        "target",
        "babel",
        "coordinates",
        "invoke",
        "related",
        "noexternallanglinks",
        "shortdesc",
        "property",
        "statements",
        "commaSeparatedList",
        "assessment",
        "chart",
        "mentor",
    },
    language_conversion_enabled: true,
    link_trail: r"/^([a-z]+)(.*)$/sD",
    protocols: phf::phf_set! {
        "//",
        "bitcoin:",
        "ftp://",
        "ftps://",
        "geo:",
        "git://",
        "gopher://",
        "http://",
        "https://",
        "irc://",
        "ircs://",
        "magnet:",
        "mailto:",
        "matrix:",
        "mms://",
        "news:",
        "nntp://",
        "redis://",
        "sftp://",
        "sip:",
        "sips:",
        "sms:",
        "ssh://",
        "svn://",
        "tel:",
        "telnet://",
        "urn:",
        "wikipedia://",
        "worldwind://",
        "xmpp:",
    },
    redirect_magic_words: phf::phf_set! { "#redirect" },
    magic_links: MagicLinks {
        isbn: false,
        pmid: false,
        rfc: false,
    },
    variables: phf::phf_set! {
        "!",
        "=",
        "currentmonth",
        "currentmonth1",
        "currentmonthname",
        "currentmonthnamegen",
        "currentmonthabbrev",
        "currentday",
        "currentday2",
        "currentdayname",
        "currentyear",
        "currenttime",
        "currenthour",
        "localmonth",
        "localmonth1",
        "localmonthname",
        "localmonthnamegen",
        "localmonthabbrev",
        "localday",
        "localday2",
        "localdayname",
        "localyear",
        "localtime",
        "localhour",
        "numberofarticles",
        "numberoffiles",
        "numberofedits",
        "articlepath",
        "pageid",
        "sitename",
        "server",
        "servername",
        "scriptpath",
        "stylepath",
        "pagename",
        "pagenamee",
        "fullpagename",
        "fullpagenamee",
        "namespace",
        "namespacee",
        "namespacenumber",
        "currentweek",
        "currentdow",
        "localweek",
        "localdow",
        "revisionid",
        "revisionday",
        "revisionday2",
        "revisionmonth",
        "revisionmonth1",
        "revisionyear",
        "revisiontimestamp",
        "revisionuser",
        "revisionsize",
        "subpagename",
        "subpagenamee",
        "talkspace",
        "talkspacee",
        "subjectspace",
        "subjectspacee",
        "talkpagename",
        "talkpagenamee",
        "subjectpagename",
        "subjectpagenamee",
        "numberofusers",
        "numberofactiveusers",
        "numberofpages",
        "currentversion",
        "rootpagename",
        "rootpagenamee",
        "basepagename",
        "basepagenamee",
        "currenttimestamp",
        "localtimestamp",
        "directionmark",
        "contentlanguage",
        "userlanguage",
        "pagelanguage",
        "numberofadmins",
        "cascadingsources",
        "bcp47",
        "dir",
        "language",
        "numberofwikis",
        "pendingchangelevel",
        "noexternallanglinks",
        "wbreponame",
    },
};

/// The installation configuration, suitable for runtime use.
pub static CONFIG: LazyLock<Configuration> = LazyLock::new(|| Configuration::new(&CONFIG_SOURCE));
